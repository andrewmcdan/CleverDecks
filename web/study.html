<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.4">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="img/favicon-180x180.png" type="image/png">
    <!-- MathJax -- This library is used to render mathematical expressions. -->
    <script>
        MathJax = {
            chtml: {
                scale: 0.9
            },
            tex: {
                formatError: (jax, error) => { jax.formatError(error); }
            },
            svg: {
                scale: 0.9
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="common.js"></script>
    <!-- Socket.io library -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="web.js"></script>
    <title>CleverDecks - Study</title>
</head>

<body class="min-w-500px flex bg-gray-600 h-auto justify-evenly">
    <div class=" bg-transparent">
        <!-- Left spacer -->
    </div>
    <div class="">
        <div class="container w-[1600px] shadow-xl bg-white shadow-black">
            <nav class="navbar bg-gray-800 text-white flex">
                <div class="items-start container px-0 py-0 flex mx-0 my-0">
                    <div id="logo" class="size-24 border-4 border-black" onclick="window.location.href = 'index.html'">
                        <img src="img/CD_logo_1024x1024.png" alt="CleverDecks">
                    </div>
                    <div class="navBtn flex items-center justify-center size-24 hover:bg-white hover:text-black "
                        onclick="window.location.href = 'index.html'">
                        <p class="text-center text-2xl">Home</p>
                    </div>
                    <div class="navBtn flex items-center justify-center size-24 bg-white text-black"
                        onclick="window.location.href = 'study.html'">
                        <p class="text-center text-2xl">Study</p>
                    </div>
                    <div class="navBtn flex items-center justify-center size-24 hover:bg-white hover:text-black"
                        onclick="window.location.href = 'quiz.html'">
                        <p class="text-center text-2xl">Quiz</p>
                    </div>
                    <div class="navBtn flex items-center justify-center size-24 hover:bg-white hover:text-black"
                        onclick="window.location.href = 'create.html'">
                        <p class="text-center text-2xl">Create</p>
                    </div>
                </div>
                <div class="px-4 realtive">
                    <div id="searchReturnContainer"
                        class="absolute gone top-10 bg-white shadow-md shadow-white rounded-sm border border-gray-200 p-4 text-black">
                        <p>Returned results: <span id="searchResultsCount">0</span></p>
                        <p>
                            <button class="jborder-2 border-black rounded-sm border bg-white p-1"
                                id="loadAddButton">Load - Add</button>
                            <button class="jborder-2 border-black rounded-sm border bg-white p-1"
                                id="loadNewButton">Load - New</button>
                        </p>
                    </div>
                    <div id="searchResultsContainer"
                        class="absolute gone top-10 bg-white shadow-md shadow-white rounded-sm border border-gray-200 p-4">
                        <ul id="searchResultsList" class="text-black w-full">
                            <!-- Search results will be added here -->
                        </ul>
                    </div>
                    <div id="cardSearch" class="size-1/2 flex items-center text-black">
                        <input type="text" id="search" placeholder="Search..." onkeyup="" autocomplete="off">
                        <button class="border-2 border-white text-white" id="searchButton">Search</button>
                    </div>
                    <div id="cardDropDown" class="size-1/2  text-black">
                        <select id="collectionSelect">
                            <option>Study a Collection(Quick Load)</option>
                        </select>
                    </div>
                </div>
            </nav>
            <div class="content" class="min-h-screen">
                <div id="cardCount" class="p-4 m-2 text-lg font-semibold">
                    Total available cards: <span id="totalAvailableCardsCount"></span>
                </div>
                <div id="totalCardCount" class="p-4 m-2 text-lg font-semibold">
                    <p>Cards loaded for study: <span id="totalLoadedCardsCount">0</span></p>
                    <p>Loaded cards from collections: <span id="loadedCardsCollections"></span></p>
                </div>
                
                <div id="flashCardContainer"
                    class="max-w-xl mx-auto p-4 bg-white shadow-2xl shadow-black drop-shadow-2xl rounded-lg m-10">
                    <div class="flex justify-between mb-3">
                        <div>Difficulty: <span id="difficultyRating" class="text-sm text-gray-600"></span></div>
                        <div>Collection: <span id="collectionName" class="text-sm text-gray-600"></span></div>
                    </div>
                    <div class="flex justify-between mb-3">
                        <div>Tags: <span id="tags" class="text-sm text-gray-600"></span></div>
                        <div>Show Answers: <input id="shgowAnswersCheck" type="checkbox" /></div>
                    </div>
                    <div class="mb-3">
                        Date Created: <span id="dateCreated" class="text-sm text-gray-600"></span>
                    </div>
                    <div class="mb-6">
                        <div>Times Studied: <span id="timesStudied" class="text-sm text-gray-600"></span></div>
                        <div>Times Skipped: <span id="timesSkipped" class="text-sm text-gray-600"></span></div>
                        <div>Times Missed: <span id="timesMissed" class="text-sm text-gray-600"></span></div>
                    </div>
                    <div id="flashCardContent" class="flashcard-flip bg-white rounded-lg shadow-lg m-10"
                        style="height: 200px; position: relative;">
                        <div id="flashcardFront"
                            class="flashcard-face flashcard-front text-lg font-medium text-gray-800 flex items-center justify-center shadow-2xl shadow-black drop-shadow-xl">
                            <p><button id="startStudying_btn1" class="relative px-4 py-2 bg-green-500 text-white rounded hover:bg-green-700 transition duration-300">Start Studying</button></p>
                            <p><div id="flashcardFrontContent" class="p-4 gone">Click "Start Studying" to begin studying.</div></p>
                        </div>
                        <div id="flashcardBack"
                            class="flashcard-face flashcard-back text-lg font-medium text-gray-800 flex items-center justify-center shadow-2xl shadow-black drop-shadow-xl">
                            <p><button id="startStudying_btn2" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-700 transition duration-300">Start Studying</button></p>
                            <p><div id="flashcardBackContent" class="p-4 gone">Click "Start Studying" to begin studying.</div></p>
                        </div>
                    </div>
                    <div class="flex justify-between">
                        <button
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-700 transition duration-300"
                            onclick="flipCard()"><p>Flip</p><p>(Space)</p></button>
                        <button id="iGotItRight_btn"
                            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-700 transition duration-300">
                            <p>I got it right!</p>
                            <p>(Next Card, D)</p>
                        </button>
                        <button id="iMissedThatOne_btn"
                            class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-700 transition duration-300">
                            <p>I missed that one</p>
                            <p>(Next Card, A)</p>
                        </button>
                        <button id="skip_btn"
                            class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-700 transition duration-300"><p>Skip</p><p>(S)</p></button>
                        <button id="flag_btn"
                            class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-700 transition duration-300 flex items-center justify-center"
                            onclick="toggleFlag()">
                            <p><img id="flagIcon" src="img/unflagged.svg" alt="unflagged" width="24px"></p><p>(W)</p></button>
                    </div>
                </div>
            </div>
            <footer class="bg-gray-800 text-white items-center justify-center w-full p-6">
                <div class="flex items-center mb-4 justify-center">
                    <a href="https://github.com/andrewmcdan/CleverDecks" target="_blank" class="px-2 py-4">GitHub</a> |
                    <a href="https://github.com/andrewmcdan/CleverDecks?tab=AGPL-3.0-1-ov-file" target="_blank"
                        class="px-2 py-4">License</a>
                    |
                    <a href="about-us.html" target="_blank" class="px-2 py-4">About Us</a> |
                    <a href="flashcards.html" target="_blank" class="px-2 py-4">My FlashCards</a>
                </div>
                <div class="footer-logo flex items-center justify-center">
                    <a href="/">
                        <img src="img/CD_logo_1024x1024.png" alt="CleverDecks Logo" style="height: 100px;">
                    </a>
                </div>
                <div class="flex items-center mt-4 justify-around">
                    <p>Copyright &copy; 2024 by Edwin Maldonado, Andrew McDaniel, Bryce Martin-White, Elizabeth King,
                        and
                        Uday
                        Kadarla. All rights reserved.</p>
                </div>
            </footer>
            <div class="fixed bottom-0 left-0 z-10 bg-black" id="status">
                <div class="flex items-center justify-center bg-red-500 text-white p-0.5" id="statusMessageContainer">
                    <p class="text-center text-l font-mono m-0 p-0" id="statusMessage">Status: Connecting</p>
                </div>
            </div>
        </div>
    </div>
    <div class=" bg-transparent">
        <!-- Left spacer -->
    </div>
</body>
<style>
    /*
        Styles unique to this page go here
        */
    .flashcard-flip {
        transform-style: preserve-3d;
        transition: transform 0.6s;
    }

    /* The flipped state of the card. */
    .flashcard-flip.flipped {
        transform: rotateY(180deg);
    }

    /* Front and back faces of the card */
    .flashcard-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        background-size: 100% 1.5em;
        background-image: linear-gradient(to bottom, #9dc1e6 1px, transparent 1px);
        /* Hide the back side of the card when flipped */
    }

    /* Styling for the back face to ensure it's flipped initially */
    .flashcard-back {
        transform: rotateY(180deg);
    }
</style>
<script>

    function flipCard() {
        const card = document.getElementById('flashCardContent');
        card.classList.toggle('flipped');
    }

    function toggleFlag() {
        const flagIcon = document.getElementById('flagIcon');
        if (flagIcon.classList.contains('flagged')) {
            flagIcon.classList.remove('flagged');
            flagIcon.src = "img/unflagged.svg";
            flagIcon.alt = "unflagged";
        } else {
            flagIcon.classList.add('flagged');
            flagIcon.src = "img/flagged.svg";
            flagIcon.alt = "flagged";
        }
    }


    (async () => {
        await CleverDecks.waitReady();



        // JavaScript unique to this page goes here
        // There is a global variable called CleverDecks that has methods for accessing the backend. See web.js for more information.

        const loadedCardCount = document.getElementById('totalLoadedCardsCount');
        const totalCardCount = document.getElementById('totalAvailableCardsCount');
        const loadedCardsCollections = document.getElementById('loadedCardsCollections');

        const startStudying_btn1 = document.getElementById('startStudying_btn1');
        const startStudying_btn2 = document.getElementById('startStudying_btn2');

        let loadedCards = [];
        let currentSubset = [];
        let currentCardIndex = 0;
        let studyIteration = 1;

        const flashCardFront = document.getElementById('flashcardFrontContent');
        const flashCardBack = document.getElementById('flashcardBackContent');

        const iGotItRight_btn = document.getElementById('iGotItRight_btn');
        const iMissedThatOne_btn = document.getElementById('iMissedThatOne_btn');
        const skip_btn = document.getElementById('skip_btn');
        const flag_btn = document.getElementById('flag_btn');
        const showAnswersCheck = document.getElementById('shgowAnswersCheck');

        showAnswersCheck.addEventListener('change', () => {
            updateFlashCard();
        });

        iGotItRight_btn.addEventListener('click', () => {
            iGotItRight();
        });

        function iGotItRight(){
            let index = loadedCards.findIndex((card) => card.id === currentSubset[currentCardIndex].id);
            loadedCards[index].timesStudied++;
            loadedCards[index].timesCorrect++;
            loadedCards[index].dateLastStudied = new Date();
            loadedCards[index].flagForUpdate = true;
            CleverDecks.updateCard(loadedCards[index]).then(() => {
                console.log('Card updated');
            }).catch((error) => {
                console.error({ error });
            });
            currentCardIndex++;
            if (currentCardIndex >= currentSubset.length) {
                selectSubset();
                currentCardIndex = 0;
                studyIteration++;
            }
            updateFlashCard();
        }

        iMissedThatOne_btn.addEventListener('click', () => {
            iMissedThatOne();
        });

        function iMissedThatOne(){
            let index = loadedCards.findIndex((card) => card.id === currentSubset[currentCardIndex].id);
            loadedCards[index].timesStudied++;
            loadedCards[index].timesIncorrect++;
            loadedCards[index].dateLastStudied = new Date();
            loadedCards[index].flagForUpdate = true;
            CleverDecks.updateCard(loadedCards[index]).then(() => {
                console.log('Card updated');
            }).catch((error) => {
                console.error({ error });
            });
            currentCardIndex++;
            if (currentCardIndex >= currentSubset.length) {
                selectSubset();
                currentCardIndex = 0;
                studyIteration++;
            }
            updateFlashCard();
        }

        skip_btn.addEventListener('click', () => {
            skip();
        });

        function skip(){
            let index = loadedCards.findIndex((card) => card.id === currentSubset[currentCardIndex].id);
            loadedCards[index].timesStudied++;
            loadedCards[index].timesSkipped++;
            loadedCards[index].flagForUpdate = true;
            CleverDecks.updateCard(loadedCards[index]).then(() => {
                console.log('Card updated');
            }).catch((error) => {
                console.error({ error });
            });
            currentCardIndex++;
            if (currentCardIndex >= currentSubset.length) {
                selectSubset();
                currentCardIndex = 0;
                studyIteration++;
            }
            updateFlashCard();
        }

        flag_btn.addEventListener('click', () => {
            flag();
        });

        function flag(){
            let index = loadedCards.findIndex((card) => card.id === currentSubset[currentCardIndex].id);
            loadedCards[index].flagForUpdate = true;
            if (loadedCards[index].timesFlagged) {
                loadedCards[index].timesFlagged = 0;
            } else {
                loadedCards[index].timesFlagged = 1;
            }
            CleverDecks.updateCard(loadedCards[index]).then(() => {
                console.log('Card updated');
            }).catch((error) => {
                console.error({ error });
            });
            updateFlashCard();
        }

        document.addEventListener('keydown', (e) => {
            e.preventDefault();
            if (e.key === ' ') {
                flipCard();
            }else if (e.key === 'w') {
                flag();
            }else if (e.key === 's') {
                skip();
            }else if (e.key === 'a') {
                iMissedThatOne();
            }else if (e.key === 'd') {
                iGotItRight();
            }else{
                // let the browser handle the event
                e.stopPropagation();
            }
        });

        startStudying_btn1.addEventListener('click', () => {
            console.log('Start studying clicked');
            // selectSubset();
            updateFlashCard();
        });

        startStudying_btn2.addEventListener('click', () => {
            console.log('Start studying clicked');
            // selectSubset();
            updateFlashCard();
        });

        

        // get count of all cards
        CleverDecks.getCardCount({ all: true }).then((count) => {
            totalCardCount.innerHTML = count;
        }).catch((error) => {
            console.error({ error });
        })

        CleverDecks.loadedCards.onArrayUpdated((e) => {
            loadedCardCount.innerHTML = e.detail.arr.length;
            let collections = e.detail.arr.map((card) => card.collection);
            collections = [...new Set(collections)];
            loadedCardsCollections.innerHTML = collections.join(', ');
            loadedCards = e.detail.arr;
        });

        CleverDecks.loadedCards.onDoneLoading((e) => {
            studyIteration=1;
            selectSubset(true);
            // updateFlashCard();
        });

        CleverDecks.loadedCards.onClearArray((e) => {
            loadedCardCount.innerHTML = 0;
            loadedCardsCollections.innerHTML = '';
            loadedCards = [];
            currentCardIndex = 0;
            currentSubset = [];
            studyIteration = 1;
            startStudying_btn1.classList.remove('gone');
            startStudying_btn2.classList.remove('gone');
            flashCardBack.classList.add('gone');
            flashCardFront.classList.add('gone');
        });


        async function updateLoadedCardsFromServer(){
            let awaiter = [];
            loadedCards.forEach((card) => {
                if(card.flagForUpdate !== undefined && card.flagForUpdate === true){
                    card.flagForUpdate = false;
                    awaiter.push(CleverDecks.getCards({id:card.id}).then((latestCard) => {
                        if(Array.isArray(latestCard) && latestCard.length == 1) loadedCards[loadedCards.findIndex((c) => c.id === card.id)] = latestCard[0];
                        else if (Array.isArray(latestCard) && latestCard.length > 1) console.error({error: "Multiple cards with the same ID"});
                        else console.error({error: "Card not found"});
                    }).catch((error) => {
                        console.error({ error });
                    }));
                }
            });
            await Promise.all(awaiter);
        }

        function updateDifficultyScores() {
            // Get the highest times studied
            let highestTimesStudied = 0;
            loadedCards.forEach((card) => {
                if (card.timesStudied > highestTimesStudied) {
                    highestTimesStudied = card.timesStudied;
                }
            });
            console.log({ highestTimesStudied });

            // Calculate the difficulty rating for each card
            loadedCards.forEach((card) => {
                let R = card.timesStudied>0?(card.timesIncorrect + card.timesSkipped) / card.timesStudied:0;
                console.log({ R });
                card.difficultyRating = R * card.difficulty * (1 + (card.timesStudied / highestTimesStudied));
            });
        }

        async function selectSubset(init = false) {
            let currentCardId = currentSubset[currentCardIndex]?.id;
            console.log({ currentSubset });
            console.log({ loadedCards });
            if(loadedCards.length === 1){
                currentSubset = loadedCards;
                currentCardIndex = 0;
                return;
            }
            // Update the loaded cards from the server
            if(!init)await updateLoadedCardsFromServer();
            // Ensure scores are up to date
            updateDifficultyScores();

            let worstRatio = Math.min(...loadedCards.map(card => {
                if(card.timesStudied === 0) return 1;
                return (card.timesIncorrect + card.timesSkipped) / card.timesStudied;
            }));
            console.log({ worstRatio });
            const ratioOffset = Math.min(0.2 / (Math.pow(studyIteration,1.02)), 1);
            const thresholdRatio = worstRatio + ratioOffset; // Adjust this value as needed
            console.log({ thresholdRatio });
            console.log({ ratioOffset });
            console.log({ studyIteration });

            // Filter cards based on their difficulty score and missed/studied ratio
            let subset = loadedCards.filter(card => {
                if(card.timesStudied === 0) return true;
                let ratio = card.timesStudied>0?(card.timesIncorrect + card.timesSkipped) / card.timesStudied:0;
                console.log({ ratio });
                return ratio >= thresholdRatio;
            });
            console.log({ subset });

            // get the minimum timesStudied
            let minTimesStudied = Math.min(...subset.map(card => card.timesStudied));
            // sort the subset by times studied. Cards that have never been studied are prioritized.
            if(minTimesStudied === 0) subset.sort((a, b) => a.timesStudied - b.timesStudied);
            // otherwise, sort by difficulty score
            else subset.sort((a, b) => a.difficultyRating - b.difficultyRating);

            // If the subset is too large, narrow it down further
            // Start with 50% of cards by default, or 10 cards, whichever is larger
            const multiplierConstant = 0.1;
            const targetSizeConstant = 10;
            const minimumNumberOfCards = 3;
            let targetMultiplier = multiplierConstant * Math.pow(studyIteration,1.02);
            let minTargetSize = Math.min(targetSizeConstant*studyIteration,loadedCards.length);
            let targetSubsetSize = Math.max(Math.ceil(loadedCards.length * targetMultiplier),minTargetSize);
            console.log({ targetSubsetSize });
            if (subset.length > targetSubsetSize) {
                // Take the top cards
                subset = subset.slice(0, targetSubsetSize);
                // Sort by difficulty score
                subset.sort((a, b) => a.difficultyRating - b.difficultyRating);
            }else if(subset.length === 0){
                subset = loadedCards.slice(0, targetSubsetSize);
            }else if(subset.length < minimumNumberOfCards){
                // If there are less than 3 cards, add more cards
                let additionalCards = loadedCards.filter(card => !subset.includes(card));
                additionalCards.sort((a, b) => a.difficultyRating - b.difficultyRating);
                subset = subset.concat(additionalCards.slice(0, 3 - subset.length));
            }
            currentSubset = subset;
            currentCardIndex = 0;
            console.log({ currentSubset });
            console.log({ loadedCards });
            if(currentCardId == currentSubset[currentCardIndex]?.id){
                currentCardIndex++;
            }
        }

        function updateFlashCard() {
            if (currentSubset.length === 0) {
                // No cards to study
                return;
            }
            startStudying_btn1.classList.add('gone');
            startStudying_btn2.classList.add('gone');
            flashCardBack.classList.remove('gone');
            flashCardFront.classList.remove('gone');
            const cardContainer = document.getElementById('flashCardContent');

            if (!showAnswersCheck.checked && cardContainer.classList.contains('flipped')) {
                cardContainer.classList.remove('flipped');
            }else if(showAnswersCheck.checked && !cardContainer.classList.contains('flipped')){
                cardContainer.classList.add('flipped');
            }

            let card = currentSubset[currentCardIndex];
            if(showAnswersCheck.checked){
                setTimeout(() => {
                    flashCardFront.innerHTML = `<p>${card.question}</p>`;
                    MathJax.typeset();
                }, 1000);
                flashCardBack.innerHTML = `<p>${card.answer}</p>`;
            }else{
                setTimeout(() => {
                    flashCardBack.innerHTML = `<p>${card.answer}</p>`;
                    MathJax.typeset();
                }, 1000);
                flashCardFront.innerHTML = `<p>${card.question}</p>`;
            }

            const difficultyRatings = ['Very Easy', 'Easy', 'Medium', 'Hard', 'Very Hard'];
            document.getElementById('difficultyRating').innerHTML = difficultyRatings[card.difficulty-1];
            document.getElementById('collectionName').innerHTML = card.collection;
            // add the tags, but limit to 5
            document.getElementById('tags').innerHTML = card.tags.slice(0, 5).join(', ');
            document.getElementById('dateCreated').innerHTML = Date(card.dateCreated).toLocaleString().substring(0, 16);
            document.getElementById('timesStudied').innerHTML = card.timesStudied;
            document.getElementById('timesSkipped').innerHTML = card.timesSkipped;
            document.getElementById('timesMissed').innerHTML = card.timesIncorrect;
            if (card.timesFlagged) {
                // add flagged class
                document.getElementById('flagIcon').classList.add('flagged');
                document.getElementById('flagIcon').src = "img/flagged.svg";
                document.getElementById('flagIcon').alt = "flagged";
            } else {
                // remove flagged class
                document.getElementById('flagIcon').classList.remove('flagged');
                document.getElementById('flagIcon').src = "img/unflagged.svg";
                document.getElementById('flagIcon').alt = "unflagged";
            }
            MathJax.typeset();
        }

        // get url parameters
        const urlParams = new URLSearchParams(window.location.search);
        const collection = urlParams.get('collection');
        if (collection) {
            let collectionSet = await CleverDecks.getCards({collection: collection});
            if(collectionSet.length > 0){
                CleverDecks.loadedCards.clearArray();
                collectionSet.forEach((card) => {
                    CleverDecks.loadedCards.addItem(card);
                });
                CleverDecks.loadedCards.doneLoading();
            }
        }
    })();
</script>

</html>